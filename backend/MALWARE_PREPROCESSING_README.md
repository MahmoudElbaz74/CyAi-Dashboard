# Malware Preprocessing Module

A complete malware analysis module that reproduces the behavior of the Colab Xception model implementation for the CyAi-Dashboard project.

## 🚀 Features

- **Xception Model Integration**: Uses `timm.create_model('xception', pretrained=True)` with proper modifications
- **Binary to Image Conversion**: Converts .exe files to 1024x1024 grayscale images
- **22-Class Classification**: Supports 22 malware families including Benign
- **Batch Processing**: Automatically scans directories for executable files
- **Error Handling**: Comprehensive error handling and logging
- **Device Support**: Automatic CPU/GPU detection and usage

## 📦 Dependencies

```bash
pip install torch torchvision timm pillow numpy
```

## 🏗️ Module Structure

### `malware_preprocessing.py`
Main module containing:
- `config`: Configuration dictionary with model parameters
- `LoadImage`: Class for converting binary files to images
- `load_model()`: Function to load and configure the Xception model
- `predict_malware()`: Function to predict malware class for a single file
- `batch_predict()`: Function to process multiple files in a directory

### `malware_preprocessing_integration.py`
Integration wrapper for the CyAi-Dashboard backend:
- `MalwarePreprocessingDetector`: Wrapper class for easy integration
- Binary classification mapping (malicious vs benign)
- Threat level determination based on malware families

## 🔧 Usage

### Basic Usage

```python
from malware_preprocessing import load_model, predict_malware

# Load the model
model = load_model()

# Predict a single file
result = predict_malware("samples/test.exe", model)
print(f"Predicted class: {result}")
```

### Batch Processing

```python
from malware_preprocessing import load_model, batch_predict

# Load the model
model = load_model()

# Process all executables in a directory
results = batch_predict("samples/", model)
for filename, prediction in results:
    print(f"{filename} -> {prediction}")
```

### Integration with Backend

```python
from malware_preprocessing_integration import MalwarePreprocessingDetector

# Create detector instance
detector = MalwarePreprocessingDetector()

# Load model
if detector.load_model():
    # Predict a file
    result = detector.predict_file("samples/test.exe")
    print(f"Result: {result}")
```

## 📊 Supported Malware Families

The model can classify files into 22 categories:

1. **AgentTesla** - Information stealer
2. **Amadey** - Botnet
3. **AsyncRAT** - Remote access trojan
4. **AveMariaRAT** - Remote access trojan
5. **Benign** - Clean files
6. **CobaltStrike** - Penetration testing framework
7. **Formbook** - Information stealer
8. **GCleaner** - Potentially unwanted program
9. **GandCrab** - Ransomware
10. **Gozi** - Banking trojan
11. **GuLoader** - Malware loader
12. **Heodo** - Banking trojan
13. **IcedID** - Banking trojan
14. **Loki** - Information stealer
15. **LummaStealer** - Information stealer
16. **Mirai** - IoT botnet
17. **NanoCore** - Remote access trojan
18. **Prometei** - Cryptocurrency miner
19. **RedLineStealer** - Information stealer
20. **RemcosRAT** - Remote access trojan
21. **SilentBuilder** - Malware builder
22. **SmokeLoader** - Malware loader

## 🎯 Model Architecture

- **Base Model**: Xception (from timm)
- **Input**: 1-channel grayscale images (224x224)
- **Output**: 22 classes (21 malware families + 1 benign)
- **Preprocessing**: Binary file → 1024x1024 grayscale → 224x224 resize
- **Device**: Automatic CPU/GPU detection

## 🔍 File Processing Pipeline

1. **Binary Reading**: Read file as raw bytes
2. **Padding/Truncation**: Ensure exactly 1,048,576 bytes (1024×1024)
3. **Reshaping**: Convert to 1024×1024 grayscale image
4. **Resizing**: Resize to 224×224 for model input
5. **Normalization**: Convert to tensor and normalize
6. **Inference**: Run through Xception model
7. **Classification**: Apply softmax and get predicted class

## 🛠️ Configuration

The module uses a configuration dictionary:

```python
config = {
    "image_shape": (224, 224),
    "model": {
        "num_classes": 22,
        "in_channels": 1
    },
    "device": "cuda" if torch.cuda.is_available() else "cpu",
    "checkpoint_path": "path/to/model.ckpt",
    "classes_names": ["AgentTesla", "Amadey", ...]
}
```

## 📝 Logging

The module includes comprehensive logging:

```python
import logging
logging.basicConfig(level=logging.INFO)
```

Logs include:
- Model loading progress
- File processing status
- Prediction results
- Error messages

## 🚨 Error Handling

The module handles various error conditions:

- **Missing checkpoint**: Clear error message with path
- **Invalid files**: Graceful handling of non-executable files
- **Model loading failures**: Detailed error reporting
- **File access errors**: Proper exception handling

## 🧪 Testing

### Test the module directly:

```bash
cd backend
python malware_preprocessing.py
```

### Test with sample files:

```bash
# Create test directory
mkdir samples

# Add test files
echo "test content" > samples/test.exe

# Run prediction
python -c "from malware_preprocessing import load_model, predict_malware; model = load_model(); print(predict_malware('samples/test.exe', model))"
```

## 🔗 Integration with CyAi-Dashboard

The module is designed to integrate seamlessly with the existing CyAi-Dashboard backend:

1. **Import**: `from malware_preprocessing import load_model, predict_malware`
2. **Use in endpoints**: Replace existing model calls with the new module
3. **Error handling**: Compatible with existing error handling patterns
4. **Logging**: Uses the same logging configuration

## 📈 Performance

- **Model Loading**: ~5-10 seconds (first time includes pretrained weights download)
- **Inference**: ~0.1-0.5 seconds per file (CPU)
- **Memory Usage**: ~500MB-1GB (depending on model size)
- **Batch Processing**: Efficient processing of multiple files

## 🔒 Security Notes

- The module processes binary files as raw bytes
- No execution of files occurs
- Safe for analyzing potentially malicious files
- All processing is done in memory

## 📚 References

- **Xception Paper**: "Xception: Deep Learning with Depthwise Separable Convolutions"
- **timm Library**: PyTorch Image Models
- **Original Colab**: Reference implementation for logic replication

## 🤝 Contributing

When modifying the module:

1. Maintain compatibility with the existing backend
2. Add proper error handling for new features
3. Update logging for new functionality
4. Test with various file types and sizes
5. Document any configuration changes

## 📄 License

This module is part of the CyAi-Dashboard project and follows the same licensing terms.
